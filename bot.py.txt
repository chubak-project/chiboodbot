import os
import requests
import json
from telegram import Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ (Ø¨Ø¹Ø¯Ø§Ù‹ Ù¾Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)
TELEGRAM_TOKEN = "8122340396:AAHlnHpKRTEAseFox0taSL3AeE9Rey8JpVs"
ACR_HOST = "identify-eu-west-1.acrcloud.com"
ACR_KEY = "99fef4750662f696546897087edc5e67"
ACR_SECRET = "rkoP16KtCwYH0VA9hwHxXkwPuMVO7jUHaTCg7GOl"

# --- ØªØ´Ø®ÛŒØµ Ø¢Ù‡Ù†Ú¯ Ø¨Ø§ ACRCloud ---
def recognize_audio(file_path):
    try:
        url = f"https://{ACR_HOST}/v1/identify"
        headers = {
            "access-key": ACR_KEY,
            "access-secret": ACR_SECRET,
            "content-type": "audio/mpeg"
        }
        
        with open(file_path, 'rb') as audio_file:
            response = requests.post(url, headers=headers, data=audio_file.read())
        
        result = json.loads(response.text)
        
        if result['status']['msg'] == 'Success':
            music = result['metadata']['music'][0]
            title = music['title']
            artist = music['artists'][0]['name']
            return f"ğŸµ Ø¢Ù‡Ù†Ú¯: {title}\nğŸ‘¤ Ù‡Ù†Ø±Ù…Ù†Ø¯: {artist}"
        else:
            return "Ø¢Ù‡Ù†Ú¯ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯! Ù„Ø·ÙØ§Ù‹ ÛŒÙ‡ ØªÛŒÚ©Ù‡ Ø¨Ù„Ù†Ø¯ØªØ± Ø¨ÙØ±Ø³Øª"
            
    except Exception as e:
        return f"Ø®Ø·Ø§: {str(e)}"

# --- Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ù‡Ù†Ú¯ Ø¯Ø± ÛŒÙˆØªÛŒÙˆØ¨ ---
def search_youtube(query):
    try:
        url = f"https://www.youtube.com/results?search_query={query.replace(' ', '+')}"
        return f"ğŸ” Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ:\n{url}"
    except:
        return "Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ"

# --- Ø¯Ø³ØªÙˆØ± /start ---
def start(update: Update, context: CallbackContext):
    update.message.reply_text(
        "Ø³Ù„Ø§Ù…! Ù…Ù† Ø¨Ø§Øª ØªØ´Ø®ÛŒØµ Ù…ÙˆØ²ÛŒÚ© Ùˆ ÙÛŒÙ„Ù…Ù…! ğŸ˜Š\n\n"
        "Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ:\n"
        "1. ÛŒÙ‡ ÙˆÛŒØ³ Ø§Ø² Ø¢Ù‡Ù†Ú¯ Ø¨Ø±Ø§Ù… Ø¨ÙØ±Ø³ØªÛŒ\n"
        "2. Ø§Ø³Ù… Ø¢Ù‡Ù†Ú¯ ÛŒØ§ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ÛŒ\n"
        "3. Ù„ÛŒÙ†Ú© Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… ÛŒÙ‡ ÙˆÛŒØ¯ÛŒÙˆ Ø¨ÙØ±Ø³ØªÛŒ\n\n"
        "Ù…Ù† Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ø¢Ù‡Ù†Ú¯ ÛŒØ§ ÙÛŒÙ„Ù… Ø±Ùˆ ØªØ´Ø®ÛŒØµ Ø¨Ø¯Ù…!"
    )

# --- Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ ---
def handle_text(update: Update, context: CallbackContext):
    text = update.message.text
    
    # Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø³Ù… Ø¢Ù‡Ù†Ú¯ Ø±Ùˆ ÙØ±Ø³ØªØ§Ø¯Ù‡
    if "http" not in text:
        result = search_youtube(text)
        update.message.reply_text(result)
    
    # Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… ÙØ±Ø³ØªØ§Ø¯Ù‡
    elif "instagram.com" in text:
        update.message.reply_text("Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú© Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…...")
        # Ø§ÛŒÙ†Ø¬Ø§ Ú©Ø¯ ØªØ´Ø®ÛŒØµ ÙÛŒÙ„Ù… Ø±Ùˆ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        update.message.reply_text("â³ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª!")

# --- Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆÛŒØ³ Ùˆ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ ---
def handle_voice(update: Update, context: CallbackContext):
    voice = update.message.voice
    file = voice.get_file()
    file.download("user_audio.mp3")
    
    result = recognize_audio("user_audio.mp3")
    update.message.reply_text(result)

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ Ø¨Ø§Øª ---
def main():
    updater = Updater(TELEGRAM_TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_text))
    dp.add_handler(MessageHandler(Filters.voice, handle_voice))
    
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()